
                <div class="variations-container">
                    <div class="card active-variation">
                        <textarea placeholder="Start your story here..." oninput="handleInput(this)">Once upon a time, in a land far away...</textarea>
                        <div class="card-controls">
                            <button class="control-btn" onclick="removeCard(this)" title="Delete variation">Ã—</button>
                        </div>
                    </div>
                    <div class="card add-card" onclick="addVariation(this.closest('.sentence-row'))">
                        +
                    </div>
                </div>
                <div class="row-controls">
                    <button class="control-btn" onclick="removeSentence(this.closest('.sentence-row'))" title="Delete sentence">Ã—</button>
                </div>
            </div>
        </div>

        <div class="add-sentence">
            <div class="card add-card" onclick="addSentence()">
                + Add Next Sentence
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div class="modal" id="exportModal">
        <div class="modal-content">
            <h3>Your Complete Story</h3>
            <textarea id="exportText" readonly></textarea>
            <div class="modal-buttons">
                <button class="secondary" onclick="copyStoryToClipboard()">ðŸ“‹ Copy</button>
                <button class="primary" onclick="closeModal('exportModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Hidden file input -->
    <input type="file" id="fileInput" accept=".json,.txt" style="display: none;" onchange="handleFileLoad(this)">

    <script>
        let touchStartX = 0;
        let touchEndX = 0;
        let saveTimeout;
        
        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.max(textarea.scrollHeight, 60) + 'px';
        }

        function handleInput(textarea) {
            autoResize(textarea);
            debouncedSave();
        }

        function addSentence() {
            const storyContainer = document.getElementById('storyContainer');
            
            const newRow = document.createElement('div');
            newRow.className = 'sentence-row';
            newRow.innerHTML = `
                <div class="variations-container">
                    <div class="card active-variation">
                        <textarea placeholder="Continue the story..." oninput="handleInput(this)"></textarea>
                        <div class="card-controls">
                            <button class="control-btn" onclick="removeCard(this)" title="Delete variation">Ã—</button>
                        </div>
                    </div>
                    <div class="card add-card" onclick="addVariation(this.closest('.sentence-row'))">
                        +
                    </div>
                </div>
                <div class="row-controls">
                    <button class="control-btn" onclick="removeSentence(this.closest('.sentence-row'))" title="Delete sentence">Ã—</button>
                </div>
            `;
            
            storyContainer.appendChild(newRow);
            
            const newTextarea = newRow.querySelector('textarea');
            newTextarea.focus();
            newRow.scrollIntoView({ behavior: 'smooth' });
            
            updateVariationIndicators(newRow);
            debouncedSave();
        }

        function addVariation(sentenceRow) {
            const container = sentenceRow.querySelector('.variations-container');
            const addButton = container.querySelector('.add-card');
            
            container.querySelectorAll('.card:not(.add-card)').forEach(card => {
                card.classList.remove('active-variation');
            });
            
            const newCard = document.createElement('div');
            newCard.className = 'card active-variation';
            newCard.innerHTML = `
                <textarea placeholder="Alternative version..." oninput="handleInput(this)"></textarea>
                <div class="card-controls">
                    <button class="control-btn" onclick="removeCard(this)" title="Delete variation">Ã—</button>
                </div>
            `;
            
            container.insertBefore(newCard, addButton);
            
            const newTextarea = newCard.querySelector('textarea');
            newTextarea.focus();
            newCard.scrollIntoView({ behavior: 'smooth', inline: 'center' });
            
            updateVariationIndicators(sentenceRow);
            debouncedSave();
        }

        function removeCard(cardControls) {
            const card = cardControls.closest('.card');
            const sentenceRow = card.closest('.sentence-row');
            const container = sentenceRow.querySelector('.variations-container');
            const variations = container.querySelectorAll('.card:not(.add-card)');
            
            if (variations.length > 1) {
                card.remove();
                
                const activeVariations = container.querySelectorAll('.active-variation');
                if (activeVariations.length === 0) {
                    const firstVariation = container.querySelector('.card:not(.add-card)');
                    if (firstVariation) {
                        firstVariation.classList.add('active-variation');
                    }
                }
                
                updateVariationIndicators(sentenceRow);
                debouncedSave();
            } else {
                alert('Each sentence needs at least one variation!');
            }
        }

        function removeSentence(sentenceRow) {
            const allRows = document.querySelectorAll('.sentence-row');
            if (allRows.length > 1) {
                sentenceRow.remove();
                debouncedSave();
            } else {
                alert('You need at least one sentence!');
            }
        }

        function updateVariationIndicators(sentenceRow) {
            const variations = sentenceRow.querySelectorAll('.card:not(.add-card)');
            variations.forEach((card, index) => {
                const existingIndicator = card.querySelector('.variation-indicator');
                if (existingIndicator) {
                    existingIndicator.remove();
                }
                
                if (variations.length > 1) {
                    const indicator = document.createElement('div');
                    indicator.className = 'variation-indicator';
                    indicator.textContent = `${index + 1}/${variations.length}`;
                    card.appendChild(indicator);
                }
            });
        }

        // Click to make a variation active
        document.addEventListener('click', function(e) {
            const card = e.target.closest('.card:not(.add-card)');
            if (card && !e.target.closest('.card-controls')) {
                const sentenceRow = card.closest('.sentence-row');
                sentenceRow.querySelectorAll('.card:not(.add-card)').forEach(c => {
                    c.classList.remove('active-variation');
                });
                card.classList.add('active-variation');
            }
        });

        // Touch handling
        document.addEventListener('touchstart', function(e) {
            touchStartX = e.changedTouches[0].screenX;
        });

        document.addEventListener('touchend', function(e) {
            touchEndX = e.changedTouches[0].screenX;
            
            const target = e.target.closest('.sentence-row');
            if (target) {
                handleVariationSwipe(target);
            }
        });

        function handleVariationSwipe(sentenceRow) {
            const swipeThreshold = 50;
            const diff = touchStartX - touchEndX;
            
            if (Math.abs(diff) > swipeThreshold) {
                const variations = Array.from(sentenceRow.querySelectorAll('.card:not(.add-card)'));
                const activeIndex = variations.findIndex(card => card.classList.contains('active-variation'));
                
                if (activeIndex !== -1) {
                    variations[activeIndex].classList.remove('active-variation');
                    
                    let newIndex;
                    if (diff > 0 && activeIndex < variations.length - 1) {
                        newIndex = activeIndex + 1;
                    } else if (diff < 0 && activeIndex > 0) {
                        newIndex = activeIndex - 1;
                    } else {
                        newIndex = diff > 0 ? 0 : variations.length - 1;
                    }
                    
                    variations[newIndex].classList.add('active-variation');
                    variations[newIndex].scrollIntoView({ behavior: 'smooth', inline: 'center' });
                }
            }
        }

        // Save and load functionality with localStorage
        function saveStory() {
            const story = [];
            document.querySelectorAll('.sentence-row').forEach(row => {
                const variations = [];
                const variationCards = row.querySelectorAll('.card:not(.add-card)');
                let activeIndex = 0;
                
                variationCards.forEach((card, index) => {
                    const textarea = card.querySelector('textarea');
                    variations.push(textarea.value);
                    if (card.classList.contains('active-variation')) {
                        activeIndex = index;
                    }
                });
                
                story.push({
                    variations: variations,
                    activeIndex: activeIndex
                });
            });
            
            try {
                localStorage.setItem('storyCards', JSON.stringify(story));
                showSaveIndicator('Story saved!', false);
            } catch (e) {
                console.error('Could not save story:', e);
                showSaveIndicator('Save failed!', true);
            }
        }

        function loadStory() {
            try {
                const saved = localStorage.getItem('storyCards');
                if (saved) {
                    const story = JSON.parse(saved);
                    const container = document.getElementById('storyContainer');
                    container.innerHTML = '';
                    
                    story.forEach(sentence => {
                        const row = document.createElement('div');
                        row.className = 'sentence-row';
                        row.innerHTML = `
                            <div class="variations-container">
                                <div class="card add-card" onclick="addVariation(this.closest('.sentence-row'))">+</div>
                            </div>
                            <div class="row-controls">
                                <button class="control-btn" onclick="removeSentence(this.closest('.sentence-row'))" title="Delete sentence">Ã—</button>
                            </div>
                        `;
                        
                        const variationsContainer = row.querySelector('.variations-container');
                        const addButton = variationsContainer.querySelector('.add-card');
                        
                        sentence.variations.forEach((text, index) => {
                            const card = document.createElement('div');
                            card.className = index === sentence.activeIndex ? 'card active-variation' : 'card';
                            card.innerHTML = `
                                <textarea oninput="handleInput(this)">${text}</textarea>
                                <div class="card-controls">
                                    <button class="control-btn" onclick="removeCard(this)" title="Delete variation">Ã—</button>
                                </div>
                            `;
                            variationsContainer.insertBefore(card, addButton);
                            autoResize(card.querySelector('textarea'));
                        });
                        
                        container.appendChild(row);
                        updateVariationIndicators(row);
                    });
                    
                    return true;
                }
            } catch (e) {
                console.error('Could not load story:', e);
            }
            return false;
        }

        // Export and file operations
        function exportStory() {
            let storyText = '';
            document.querySelectorAll('.sentence-row').forEach(row => {
                const activeCard = row.querySelector('.active-variation textarea');
                if (activeCard && activeCard.value.trim()) {
                    storyText += activeCard.value.trim() + ' ';
                }
            });
            
            document.getElementById('exportText').value = storyText.trim();
            document.getElementById('exportModal').classList.add('show');
        }

        function copyStoryToClipboard() {
            const textarea = document.getElementById('exportText');
            textarea.select();
            document.execCommand('copy');
            showSaveIndicator('Copied to clipboard!', false);
        }

        function saveToFile() {
            const story = [];
            document.querySelectorAll('.sentence-row').forEach(row => {
                const variations = [];
                const variationCards = row.querySelectorAll('.card:not(.add-card)');
                let activeIndex = 0;
                
                variationCards.forEach((card, index) => {
                    const textarea = card.querySelector('textarea');
                    variations.push(textarea.value);
                    if (card.classList.contains('active-variation')) {
                        activeIndex = index;
                    }
                });
                
                story.push({
                    variations: variations,
                    activeIndex: activeIndex
                });
            });
            
            const dataStr = JSON.stringify(story, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'my-story.json';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showSaveIndicator('Story downloaded!', false);
        }

        function loadFromFile() {
            document.getElementById('fileInput').click();
        }

        function handleFileLoad(input) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const story = JSON.parse(e.target.result);
                        loadStoryData(story);
                        showSaveIndicator('Story loaded!', false);
                    } catch (error) {
                        showSaveIndicator('Invalid file format!', true);
                    }
                };
                reader.readAsText(file);
            }
        }

        function loadStoryData(story) {
            const container = document.getElementById('storyContainer');
            container.innerHTML = '';
            
            story.forEach(sentence => {
                const row = document.createElement('div');
                row.className = 'sentence-row';
                row.innerHTML = `
                    <div class="variations-container">
                        <div class="card add-card" onclick="addVariation(this.closest('.sentence-row'))">+</div>
                    </div>
                    <div class="row-controls">
                        <button class="control-btn" onclick="removeSentence(this.closest('.sentence-row'))" title="Delete sentence">Ã—</button>
                    </div>
                `;
                
                const variationsContainer = row.querySelector('.variations-container');
                const addButton = variationsContainer.querySelector('.add-card');
                
                sentence.variations.forEach((text, index) => {
                    const card = document.createElement('div');
                    card.className = index === sentence.activeIndex ? 'card active-variation' : 'card';
                    card.innerHTML = `
                        <textarea oninput="handleInput(this)">${text}</textarea>
                        <div class="card-controls">
                            <button class="control-btn" onclick="removeCard(this)" title="Delete variation">Ã—</button>
                        </div>
                    `;
                    variationsContainer.insertBefore(card, addButton);
                    autoResize(card.querySelector('textarea'));
                });
                
                container.appendChild(row);
                updateVariationIndicators(row);
            });
            
            debouncedSave();
        }

        function clearStory() {
            if (confirm('Are you sure you want to start a new story? This will clear all current content.')) {
                const container = document.getElementById('storyContainer');
                container.innerHTML = `
                    <div class="sentence-row">
                        <div class="variations-container">
                            <div class="card active-variation">
                                <textarea placeholder="Start your story here..." oninput="handleInput(this)"></textarea>
                                <div class="card-controls">
                                    <button class="control-btn" onclick="removeCard(this)" title="Delete variation">Ã—</button>
                                </div>
                            </div>
                            <div class="card add-card" onclick="addVariation(this.closest('.sentence-row'))">
                                +
                            </div>
                        </div>
                        <div class="row-controls">
                            <button class="control-btn" onclick="removeSentence(this.closest('.sentence-row'))" title="Delete sentence">Ã—</button>
                        </div>
                    </div>
                `;
                
                const textarea = container.querySelector('textarea');
                autoResize(textarea);
                textarea.focus();
                
                updateVariationIndicators(container.querySelector('.sentence-row'));
                debouncedSave();
                showSaveIndicator('New story started!', false);
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        function debouncedSave() {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(saveStory, 1000);
        }

        function showSaveIndicator(message, isError = false) {
            const indicator = document.getElementById('saveIndicator');
            indicator.textContent = message;
            indicator.classList.toggle('error', isError);
            indicator.classList.add('show');
            setTimeout(() => {
                indicator.classList.remove('show');
            }, 2000);
        }

        // Close modal when clicking outside
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                e.target.classList.remove('show');
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            const loaded = loadStory();
            
            if (!loaded) {
                // Initialize indicators for default content
                document.querySelectorAll('.sentence-row').forEach(row => {
                    updateVariationIndicators(row);
                    row.querySelectorAll('textarea').forEach(textarea => {
                        autoResize(textarea);
                    });
                });
            }
        });

        // Save when leaving the page
        window.addEventListener('beforeunload', function() {
            saveStory();
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 's':
                        e.preventDefault();
                        saveStory();
                        showSaveIndicator('Story saved!', false);
                        break;
                    case 'e':
                        e.preventDefault();
                        exportStory();
                        break;
                    case 'n':
                        e.preventDefault();
                        addSentence();
                        break;
                }
            }
        });
    </script>
</body>
</html>
