<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#4a4a4a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Story Cards">
    <title>Story Cards</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Georgia', 'Times New Roman', serif;
            background: linear-gradient(135deg, #f5f5f0 0%, #e8e6e0 100%);
            min-height: 100vh;
            padding: 20px;
            color: #2d2d2d;
            overflow-y: auto;
        }

        .app-container {
            max-width: 100%;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            color: #4a4a4a;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header p {
            color: #666;
            font-size: 1.1rem;
        }

        .toolbar {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .toolbar button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .toolbar button:hover {
            background: #45a049;
            transform: translateY(-1px);
        }

        .toolbar button.secondary {
            background: #6c757d;
        }

        .toolbar button.secondary:hover {
            background: #5a6268;
        }

        .story-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 30px;
        }

        .sentence-row {
            position: relative;
            overflow-x: auto;
            scrollbar-width: thin;
            scrollbar-color: #ccc #f0f0f0;
        }

        .sentence-row::-webkit-scrollbar {
            height: 6px;
        }

        .sentence-row::-webkit-scrollbar-track {
            background: #f0f0f0;
            border-radius: 3px;
        }

        .sentence-row::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 3px;
        }

        .variations-container {
            display: flex;
            gap: 12px;
            padding: 10px 0;
            min-height: 120px;
        }

        .card {
            background: #fefefe;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            min-height: 100px;
            min-width: 220px;
            max-width: 280px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            box-shadow: 0 3px 8px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            position: relative;
            cursor: text;
        }

        .card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
            transform: translateY(-1px);
        }

        .card textarea {
            width: 100%;
            height: 100%;
            min-height: 60px;
            border: none;
            background: transparent;
            font-family: 'Georgia', 'Times New Roman', serif;
            font-size: 1rem;
            line-height: 1.5;
            color: #2d2d2d;
            resize: none;
            outline: none;
        }

        .add-card {
            background: linear-gradient(135deg, #e8f4f8 0%, #d1e7dd 100%);
            border: 1px dashed #a8d8b9;
            color: #5a7c65;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 60px;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .add-card:hover {
            background: linear-gradient(135deg, #d1e7dd 0%, #c3e6cb 100%);
            border-color: #8fbc8f;
            transform: scale(1.05);
        }

        .add-sentence {
            display: flex;
            justify-content: center;
            margin: 20px 0;
        }

        .add-sentence .card {
            min-width: 150px;
            min-height: 50px;
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b3 100%);
            border: 1px dashed #ffb74d;
            color: #f57f17;
            font-size: 1rem;
            padding: 10px 20px;
        }

        .add-sentence .card:hover {
            background: linear-gradient(135deg, #ffe0b3 0%, #ffcc80 100%);
            border-color: #ff9800;
        }

        .row-controls {
            position: absolute;
            top: -10px;
            right: 10px;
            display: flex;
            gap: 5px;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 10;
        }

        .sentence-row:hover .row-controls {
            opacity: 1;
        }

        .card-controls {
            position: absolute;
            top: -8px;
            right: -8px;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 5;
        }

        .card:hover .card-controls {
            opacity: 1;
        }

        .control-btn {
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .control-btn:hover {
            background: #ff5252;
            transform: scale(1.1);
        }

        .variation-indicator {
            position: absolute;
            bottom: 10px;
            right: 15px;
            background: #6c757d;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            opacity: 0.7;
        }

        .active-variation {
            border: 2px solid #4CAF50;
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.3);
        }

        .instructions {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            color: #555;
        }

        .instructions h3 {
            margin-bottom: 10px;
            color: #4a4a4a;
        }

        .instructions ul {
            margin-left: 20px;
        }

        .instructions li {
            margin-bottom: 5px;
        }

        .save-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4CAF50;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.9rem;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 1000;
        }

        .save-indicator.show {
            opacity: 1;
        }

        .save-indicator.error {
            background: #f44336;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 90%;
            max-height: 80%;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .modal-content h3 {
            margin-bottom: 15px;
            color: #4a4a4a;
        }

        .modal-content textarea {
            width: 100%;
            height: 400px;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 15px;
            font-family: 'Georgia', serif;
            font-size: 1rem;
            line-height: 1.6;
            resize: vertical;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: flex-end;
        }

        .modal-buttons button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .modal-buttons .primary {
            background: #4CAF50;
            color: white;
        }

        .modal-buttons .secondary {
            background: #6c757d;
            color: white;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .card {
                min-width: 200px;
                max-width: 250px;
            }
            
            .toolbar {
                justify-content: center;
            }
            
            .toolbar button {
                padding: 8px 16px;
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <h1>Story Cards</h1>
            <p>Build your story sentence by sentence, explore variations</p>
        </div>

        <div class="save-indicator" id="saveIndicator">Story saved!</div>

        <div class="toolbar">
            <button onclick="exportStory()">📖 Read Story</button>
            <button onclick="saveToFile()" class="secondary">💾 Download</button>
            <button onclick="loadFromFile()" class="secondary">📂 Load File</button>
            <button onclick="clearStory()" class="secondary">🗑️ New Story</button>
        </div>

        <div class="instructions">
            <h3>How to use:</h3>
            <ul>
                <li><strong>Y-axis (vertical):</strong> Story flows downward - add new sentences with the orange + button</li>
                <li><strong>X-axis (horizontal):</strong> Swipe left/right to explore variations of each sentence</li>
                <li><strong>Auto-save:</strong> Your story saves automatically to your browser</li>
                <li><strong>Export:</strong> Use toolbar to read, download, or share your story</li>
            </ul>
        </div>

        <div class="story-container" id="storyContainer">
            <div class="sentence-row">
                <div class="variations-container">
                    <div class="card active-variation">
                        <textarea placeholder="Start your story here..." oninput="handleInput(this)">Once upon a time, in a land far away...</textarea>
                        <div class="card-controls">
                            <button class="control-btn" onclick="removeCard(this)" title="Delete variation">×</button>
                        </div>
                    </div>
                    <div class="card add-card" onclick="addVariation(this.closest('.sentence-row'))">
                        +
                    </div>
                </div>
                <div class="row-controls">
                    <button class="control-btn" onclick="removeSentence(this.closest('.sentence-row'))" title="Delete sentence">×</button>
                </div>
            </div>
        </div>

        <div class="add-sentence">
            <div class="card add-card" onclick="addSentence()">
                + Add Next Sentence
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div class="modal" id="exportModal">
        <div class="modal-content">
            <h3>Your Complete Story</h3>
            <textarea id="exportText" readonly></textarea>
            <div class="modal-buttons">
                <button class="secondary" onclick="copyStoryToClipboard()">📋 Copy</button>
                <button class="primary" onclick="closeModal('exportModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Hidden file input -->
    <input type="file" id="fileInput" accept=".json,.txt" style="display: none;" onchange="handleFileLoad(this)">

    <script>
        let touchStartX = 0;
        let touchEndX = 0;
        let saveTimeout;
        
        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.max(textarea.scrollHeight, 60) + 'px';
        }

        function handleInput(textarea) {
            autoResize(textarea);
            debouncedSave();
        }

        function addSentence() {
            const storyContainer = document.getElementById('storyContainer');
            
            const newRow = document.createElement('div');
            newRow.className = 'sentence-row';
            newRow.innerHTML = `
                <div class="variations-container">
                    <div class="card active-variation">
                        <textarea placeholder="Continue the story..." oninput="handleInput(this)"></textarea>
                        <div class="card-controls">
                            <button class="control-btn" onclick="removeCard(this)" title="Delete variation">×</button>
                        </div>
                    </div>
                    <div class="card add-card" onclick="addVariation(this.closest('.sentence-row'))">
                        +
                    </div>
                </div>
                <div class="row-controls">
                    <button class="control-btn" onclick="removeSentence(this.closest('.sentence-row'))" title="Delete sentence">×</button>
                </div>
            `;
            
            storyContainer.appendChild(newRow);
            
            const newTextarea = newRow.querySelector('textarea');
            newTextarea.focus();
            newRow.scrollIntoView({ behavior: 'smooth' });
            
            updateVariationIndicators(newRow);
            debouncedSave();
        }

        function addVariation(sentenceRow) {
            const container = sentenceRow.querySelector('.variations-container');
            const addButton = container.querySelector('.add-card');
            
            container.querySelectorAll('.card:not(.add-card)').forEach(card => {
                card.classList.remove('active-variation');
            });
            
            const newCard = document.createElement('div');
            newCard.className = 'card active-variation';
            newCard.innerHTML = `
                <textarea placeholder="Alternative version..." oninput="handleInput(this)"></textarea>
                <div class="card-controls">
                    <button class="control-btn" onclick="removeCard(this)" title="Delete variation">×</button>
                </div>
            `;
            
            container.insertBefore(newCard, addButton);
            
            const newTextarea = newCard.querySelector('textarea');
            newTextarea.focus();
            newCard.scrollIntoView({ behavior: 'smooth', inline: 'center' });
            
            updateVariationIndicators(sentenceRow);
            debouncedSave();
        }

        function removeCard(cardControls) {
            const card = cardControls.closest('.card');
            const sentenceRow = card.closest('.sentence-row');
            const container = sentenceRow.querySelector('.variations-container');
            const variations = container.querySelectorAll('.card:not(.add-card)');
            
            if (variations.length > 1) {
                card.remove();
                
                const activeVariations = container.querySelectorAll('.active-variation');
                if (activeVariations.length === 0) {
                    const firstVariation = container.querySelector('.card:not(.add-card)');
                    if (firstVariation) {
                        firstVariation.classList.add('active-variation');
                    }
                }
                
                updateVariationIndicators(sentenceRow);
                debouncedSave();
            } else {
                alert('Each sentence needs at least one variation!');
            }
        }

        function removeSentence(sentenceRow) {
            const allRows = document.querySelectorAll('.sentence-row');
            if (allRows.length > 1) {
                sentenceRow.remove();
                debouncedSave();
            } else {
                alert('You need at least one sentence!');
            }
        }

        function updateVariationIndicators(sentenceRow) {
            const variations = sentenceRow.querySelectorAll('.card:not(.add-card)');
            variations.forEach((card, index) => {
                const existingIndicator = card.querySelector('.variation-indicator');
                if (existingIndicator) {
                    existingIndicator.remove();
                }
                
                if (variations.length > 1) {
                    const indicator = document.createElement('div');
                    indicator.className = 'variation-indicator';
                    indicator.textContent = `${index + 1}/${variations.length}`;
                    card.appendChild(indicator);
                }
            });
        }

        // Click to make a variation active
        document.addEventListener('click', function(e) {
            const card = e.target.closest('.card:not(.add-card)');
            if (card && !e.target.closest('.card-controls')) {
                const sentenceRow = card.closest('.sentence-row');
                sentenceRow.querySelectorAll('.card:not(.add-card)').forEach(c => {
                    c.classList.remove('active-variation');
                });
                card.classList.add('active-variation');
            }
        });

        // Touch handling
        document.addEventListener('touchstart', function(e) {
            touchStartX = e.changedTouches[0].screenX;
        });

        document.addEventListener('touchend', function(e) {
            touchEndX = e.changedTouches[0].screenX;
            
            const target = e.target.closest('.sentence-row');
            if (target) {
                handleVariationSwipe(target);
            }
        });

        function handleVariationSwipe(sentenceRow) {
            const swipeThreshold = 50;
            const diff = touchStartX - touchEndX;
            
            if (Math.abs(diff) > swipeThreshold) {
                const variations = Array.from(sentenceRow.querySelectorAll('.card:not(.add-card)'));
                const activeIndex = variations.findIndex(card => card.classList.contains('active-variation'));
                
                if (activeIndex !== -1) {
                    variations[activeIndex].classList.remove('active-variation');
                    
                    let newIndex;
                    if (diff > 0 && activeIndex < variations.length - 1) {
                        newIndex = activeIndex + 1;
                    } else if (diff < 0 && activeIndex > 0) {
                        newIndex = activeIndex - 1;
                    } else {
                        newIndex = diff > 0 ? 0 : variations.length - 1;
                    }
                    
                    variations[newIndex].classList.add('active-variation');
                    variations[newIndex].scrollIntoView({ behavior: 'smooth', inline: 'center' });
                }
            }
        }

        // Save and load functionality with localStorage
        function saveStory() {
            const story = [];
            document.querySelectorAll('.sentence-row').forEach(row => {
                const variations = [];
                const variationCards = row.querySelectorAll('.card:not(.add-card)');
                let activeIndex = 0;
                
                variationCards.forEach((card, index) => {
                    const textarea = card.querySelector('textarea');
                    variations.push(textarea.value);
                    if (card.classList.contains('active-variation')) {
                        activeIndex = index;
                    }
                });
                
                story.push({
                    variations: variations,
                    activeIndex: activeIndex
                });
            });
            
            try {
                localStorage.setItem('storyCards', JSON.stringify(story));
                showSaveIndicator('Story saved!', false);
            } catch (e) {
                console.error('Could not save story:', e);
                showSaveIndicator('Save failed!', true);
            }
        }

        function loadStory() {
            try {
                const saved = localStorage.getItem('storyCards');
                if (saved) {
                    const story = JSON.parse(saved);
                    const container = document.getElementById('storyContainer');
                    container.innerHTML = '';
                    
                    story.forEach(sentence => {
                        const row = document.createElement('div');
                        row.className = 'sentence-row';
                        row.innerHTML = `
                            <div class="variations-container">
                                <div class="card add-card" onclick="addVariation(this.closest('.sentence-row'))">+</div>
                            </div>
                            <div class="row-controls">
                                <button class="control-btn" onclick="removeSentence(this.closest('.sentence-row'))" title="Delete sentence">×</button>
                            </div>
                        `;
                        
                        const variationsContainer = row.querySelector('.variations-container');
                        const addButton = variationsContainer.querySelector('.add-card');
                        
                        sentence.variations.forEach((text, index) => {
                            const card = document.createElement('div');
                            card.className = index === sentence.activeIndex ? 'card active-variation' : 'card';
                            card.innerHTML = `
                                <textarea oninput="handleInput(this)">${text}</textarea>
                                <div class="card-controls">
                                    <button class="control-btn" onclick="removeCard(this)" title="Delete variation">×</button>
                                </div>
                            `;
                            variationsContainer.insertBefore(card, addButton);
                            autoResize(card.querySelector('textarea'));
                        });
                        
                        container.appendChild(row);
                        updateVariationIndicators(row);
                    });
                    
                    return true;
                }
            } catch (e) {
                console.error('Could not load story:', e);
            }
            return false;
        }

        // Export and file operations
        function exportStory() {
            let storyText = '';
            document.querySelectorAll('.sentence-row').forEach(row => {
                const activeCard = row.querySelector('.active-variation textarea');
                if (activeCard && activeCard.value.trim()) {
                    storyText += activeCard.value.trim() + ' ';
                }
            });
            
            document.getElementById('exportText').value = storyText.trim();
            document.getElementById('exportModal').classList.add('show');
        }

        function copyStoryToClipboard() {
            const textarea = document.getElementById('exportText');
            textarea.select();
            document.execCommand('copy');
            showSaveIndicator('Copied to clipboard!', false);
        }

        function saveToFile() {
            const story = [];
            document.querySelectorAll('.sentence-row').forEach(row => {
                const variations = [];
                const variationCards = row.querySelectorAll('.card:not(.add-card)');
                let activeIndex = 0;
                
                variationCards.forEach((card, index) => {
                    const textarea = card.querySelector('textarea');
                    variations.push(textarea.value);
                    if (card.classList.contains('active-variation')) {
                        activeIndex = index;
                    }
                });
                
                story.push({
                    variations: variations,
                    activeIndex: activeIndex
                });
            });
            
            const dataStr = JSON.stringify(story, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'my-story.json';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showSaveIndicator('Story downloaded!', false);
        }

        function loadFromFile() {
            document.getElementById('fileInput').click();
        }

        function handleFileLoad(input) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const story = JSON.parse(e.target.result);
                        loadStoryData(story);
                        showSaveIndicator('Story loaded!', false);
                    } catch (error) {
                        showSaveIndicator('Invalid file format!', true);
                    }
                };
                reader.readAsText(file);
            }
        }

        function loadStoryData(story) {
            const container = document.getElementById('storyContainer');
            container.innerHTML = '';
            
            story.forEach(sentence => {
                const row = document.createElement('div');
                row.className = 'sentence-row';
                row.innerHTML = `
                    <div class="variations-container">
                        <div class="card add-card" onclick="addVariation(this.closest('.sentence-row'))">+</div>
                    </div>
                    <div class="row-controls">
                        <button class="control-btn" onclick="removeSentence(this.closest('.sentence-row'))" title="Delete sentence">×</button>
                    </div>
                `;
                
                const variationsContainer = row.querySelector('.variations-container');
                const addButton = variationsContainer.querySelector('.add-card');
                
                sentence.variations.forEach((text, index) => {
                    const card = document.createElement('div');
                    card.className = index === sentence.activeIndex ? 'card active-variation' : 'card';
                    card.innerHTML = `
                        <textarea oninput="handleInput(this)">${text}</textarea>
                        <div class="card-controls">
                            <button class="control-btn" onclick="removeCard(this)" title="Delete variation">×</button>
                        </div>
                    `;
                    variationsContainer.insertBefore(card, addButton);
                    autoResize(card.querySelector('textarea'));
                });
                
                container.appendChild(row);
                updateVariationIndicators(row);
            });
            
            debouncedSave();
        }

        function clearStory() {
            if (confirm('Are you sure you want to start a new story? This will clear all current content.')) {
                const container = document.getElementById('storyContainer');
                container.innerHTML = `
                    <div class="sentence-row">
                        <div class="variations-container">
                            <div class="card active-variation">
                                <textarea placeholder="Start your story here..." oninput="handleInput(this)"></textarea>
                                <div class="card-controls">
                                    <button class="control-btn" onclick="removeCard(this)" title="Delete variation">×</button>
                                </div>
                            </div>
                            <div class="card add-card" onclick="addVariation(this.closest('.sentence-row'))">
                                +
                            </div>
                        </div>
                        <div class="row-controls">
                            <button class="control-btn" onclick="removeSentence(this.closest('.sentence-row'))" title="Delete sentence">×</button>
                        </div>
                    </div>
                `;
                
                const textarea = container.querySelector('textarea');
                autoResize(textarea);
                textarea.focus();
                
                updateVariationIndicators(container.querySelector('.sentence-row'));
                debouncedSave();
                showSaveIndicator('New story started!', false);
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        function debouncedSave() {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(saveStory, 1000);
        }

        function showSaveIndicator(message, isError = false) {
            const indicator = document.getElementById('saveIndicator');
            indicator.textContent = message;
            indicator.classList.toggle('error', isError);
            indicator.classList.add('show');
            setTimeout(() => {
                indicator.classList.remove('show');
            }, 2000);
        }

        // Close modal when clicking outside
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                e.target.classList.remove('show');
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            const loaded = loadStory();
            
            if (!loaded) {
                // Initialize indicators for default content
                document.querySelectorAll('.sentence-row').forEach(row => {
                    updateVariationIndicators(row);
                    row.querySelectorAll('textarea').forEach(textarea => {
                        autoResize(textarea);
                    });
                });
            }
        });

        // Save when leaving the page
        window.addEventListener('beforeunload', function() {
            saveStory();
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 's':
                        e.preventDefault();
                        saveStory();
                        showSaveIndicator('Story saved!', false);
                        break;
                    case 'e':
                        e.preventDefault();
                        exportStory();
                        break;
                    case 'n':
                        e.preventDefault();
                        addSentence();
                        break;
                }
            }
        });
    </script>
</body>
</html>